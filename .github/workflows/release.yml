name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run all checks
        run: |
          npm run type-check
          npm run lint
          npm run test:coverage

  build-release:
    name: Build Release
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build production extension
        run: npm run build

      - name: Create release package
        run: |
          cd dist
          zip -r ../flowcraft-${{ github.ref_name }}.zip .
          cd ..

      - name: Generate checksums
        run: |
          sha256sum flowcraft-${{ github.ref_name }}.zip > checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            flowcraft-${{ github.ref_name }}.zip
            checksums.txt
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Chrome Web Store (placeholder)
        run: |
          echo "üöÄ Ready for Chrome Web Store submission"
          echo "Package: flowcraft-${{ github.ref_name }}.zip"
          # Future: Integrate with Chrome Web Store API
          # This would require CHROME_CLIENT_ID, CHROME_CLIENT_SECRET, and CHROME_REFRESH_TOKEN

  notify:
    name: Release Notification
    runs-on: ubuntu-latest
    needs: build-release
    if: always()
    steps:
      - name: Notify success
        if: needs.build-release.result == 'success'
        run: |
          echo "‚úÖ Release ${{ github.ref_name }} published successfully!"

      - name: Notify failure
        if: needs.build-release.result != 'success'
        run: |
          echo "‚ùå Release ${{ github.ref_name }} failed!"
          exit 1
